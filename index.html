<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Patrimônio</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Outfit', sans-serif; font-weight: 300; margin: 0; padding: 20px; background: #f6f8fb; color: #464646; }
        .container { max-width: 800px; margin: 28px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(11,36,71,0.06); }
        h1 { font-size: 24px; margin-bottom: 10px; color: #464646; text-align: center; }
        b { font-family: 'Outfit', sans-serif; font-weight: 700; color: #FF6400; }
        p.lead { color: #374151; margin-top: 0; }
        .inputs { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .input-group { display: flex; flex-direction: column; }
        .input-group.full-width { grid-column: 1 / -1; }
        .input-group.two-columns { grid-column: span 2; }
        .input-group.small-field input { width: 90px; }
        .hidden-input-group { display: none; }
        label { font-size: 14px; color: #334155; margin-bottom: 5px; }
        input.valor { padding: 10px; border: 1px solid #e6e9ef; border-radius: 8px; font-size: 16px; width: 100%; box-sizing: border-box; }
        .seguro-container { display: flex; flex-direction: column; gap: 10px; }
        .seguro-container .input-group { flex-grow: 1; }
        .scenario-selection { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .scenario-btn { padding: 10px 12px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; border: 1px solid #464646; background-color: white; color: #464646; text-align: center; transition: all 0.2s ease-in-out; }
        .scenario-btn.selected { background-color: #464646; color: white; }
        .radio-group { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-around; gap: 10px; }
        .radio-btn { padding: 10px 12px; font-size: 14px; font-weight: bold; border-radius: 8px; cursor: pointer; border: 1px solid #464646; background-color: white; color: #464646; text-align: center; flex-grow: 1; }
        .radio-btn.selected { background-color: #464646; color: white; }
        .resultados { margin-top: 20px; text-align: center; }
        .valores-finais { display: flex; justify-content: space-around; flex-wrap: wrap; margin-bottom: 20px; }
        .valores-finais p { font-size: 18px; font-weight: bold; color: #464646; margin: 5px; }
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; }
        .custo-valorizacao { text-align: center; font-size: 16px; margin-bottom: 10px; }
        .custo-valorizacao b { font-size: 18px; }
        .value-display { padding: 10px; border: 1px solid #e6e9ef; border-radius: 8px; font-size: 16px; background-color: #f0f2f5; display: flex; align-items: center; justify-content: center; text-align: center; }
        .table-container { max-height: 400px; overflow-y: auto; overflow-x: auto; margin-top: 20px; padding: 10px; border: 1px solid #e6e9ef; border-radius: 8px; background-color: #fcfcfc; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; text-align: right; }
        thead { position: sticky; top: 0; background-color: #fff; z-index: 10; }
        th, td { padding: 10px; border-bottom: 1px solid #e6e9ef; }
        th { background-color: #f0f2f5; font-weight: bold; text-align: center; white-space: nowrap; }
        tbody tr:nth-child(even) { background-color: #fafafa; }
        .error-message { color: #d63031; font-weight: bold; text-align: center; margin-top: 10px; display: none; }
        .subtitle { font-size: 18px; font-weight: bold; color: #000; margin-top: 25px; margin-bottom: 15px; text-align: center; width: 100%; grid-column: 1 / -1; }
        .display-group { display: flex; gap: 15px; }
        .display-group .input-group { flex-grow: 1; }

        @media (max-width: 600px) {
            .inputs { grid-template-columns: 1fr; }
            .input-group.full-width, .input-group.two-columns, .display-group { grid-column: 1 / -1; flex-direction: column; }
            .radio-group, .scenario-selection { flex-direction: column; }
            .radio-btn, .scenario-btn { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulador de Patrimônio</h1>
        <p class="lead">Compare o crescimento do seu patrimônio com <b>consórcio</b> para compra de imóvel vs. investimento em <b>renda fixa</b>.</p>
        
        <h2 class="subtitle">Informações do Consórcio</h2>

        <div id="error-message" class="error-message"></div>

        <div class="inputs">
            
<div class="input-group">
                <label for="valorCarta"><b>Valor da Carta de Crédito (R$)</b></label>
                <input type="text" id="valorCarta" value="R$ 300.000,00" class="valor" data-tipo="moeda" maxlength="15">
            </div>

            
<div class="input-group small-field">
                <label for="prazoTotalMeses"><b>Prazo Total (meses)</b></label>
                <input type="number" id="prazoTotalMeses" value="200" class="valor" maxlength="3">
            </div>
            <div class="input-group small-field">
                <label for="taxaAdmTotal"><b>Taxa de Administração Total (%)</b></label>
                <input type="text" id="taxaAdmTotal" value="19%" class="valor" data-tipo="percentual" maxlength="3">
            </div>
            <div class="input-group small-field">
                <label for="fundoReservaTotal"><b>Fundo de Reserva Total (%):</b></label>
                <input type="text" id="fundoReservaTotal" value="2%" class="valor" data-tipo="percentual" maxlength="3">
            </div>

            
<div class="seguro-container">
                <div class="input-group small-field">
                    <label for="percentualSeguroMensal"><b>Seguro Mensal (% da Carta)</b></label>
                    <input type="text" id="percentualSeguroMensal" value="0,038%" class="valor" data-tipo="percentual" maxlength="6">
                </div>
                <div class="radio-group">
                    <button id="btnComSeguro" class="radio-btn"><b>Com Seguro</b></button>
                    <button id="btnSemSeguro" class="radio-btn selected"><b>Sem Seguro</b></button>
                </div>
            </div>
            <div class="input-group small-field">
                <label for="percentualReducao"><b>Redução da Parcela até Contemplação (% e Prazo)</b></label>
                <input type="text" id="percentualReducao" value="50%" class="valor" data-tipo="percentual" maxlength="3">
            </div>
            
            <h2 class="subtitle">Simulação de Contemplação</h2>

            
<div class="input-group">
                <label for="valorLanceRecursoProprio"><b>Lance Recurso Proprio (R$)</b></label>
                <input type="text" id="valorLanceRecursoProprio" value="R$ 100.000,00" class="valor" data-tipo="moeda" maxlength="15">
            </div>
            <div class="input-group small-field">
                <label for="percentualLanceEmbutido"><b>Lance Embutido (%)</b></label>
                <input type="text" id="percentualLanceEmbutido" value="30%" class="valor" data-tipo="percentual" maxlength="3">
            </div>
            <div class="input-group small-field">
                <label for="mesContemplacao"><b>Mês da Contemplação</b></label>
                <input type="number" id="mesContemplacao" value="13" class="valor" maxlength="3">
            </div>

            
<div class="input-group">
                <label for="valorLance"><b>Valor Total do Lance (R$ e %)</b></label>
                <p id="valorLance" class="value-display">R$ 0,00 (0%)</p>
            </div>
            <div class="input-group">
                <label for="valorCreditoPosContemplacao"><b>Crédito Pós-Contemplação (R$)</b></label>
                <p id="valorCreditoPosContemplacao" class="value-display">R$ 0,00</p>
            </div>
            
            <h2 class="subtitle">Dados para Projeção</h2>

            
<div class="input-group small-field">
                <label for="reajusteAnualCarta"><b>Reajuste Anual da Carta (%)</b></label>
                <input type="text" id="reajusteAnualCarta" value="5%" class="valor" data-tipo="percentual">
            </div>
            <div class="input-group small-field">
                <label for="valorizacaoAnualImovel"><b>Valorização Anual do Imóvel (%)</b></label>
                <input type="text" id="valorizacaoAnualImovel" value="5%" class="valor" data-tipo="percentual">
            </div>
            <div class="input-group small-field">
                <label for="rendimentoAnualRF"><b>Rendimento Anual da Renda Fixa (%)</b></label>
                <input type="text" id="rendimentoAnualRF" value="10%" class="valor" data-tipo="percentual">
            </div>

            
<div class="input-group small-field">
                <label for="percentualAluguel"><b>Percentual do Aluguel (%)</b></label>
                <input type="text" id="percentualAluguel" value="0,5%" class="valor" data-tipo="percentual">
            </div>
            <div class="input-group">
                <label for="aluguelInicialDisplay"><b>Aluguel Inicial (R$)</b></label>
                <p id="aluguelInicialDisplay" class="value-display">R$ 0,00</p>
            </div>
            
            <div id="mesCompraImovelGroup" class="input-group hidden-input-group full-width">
                <label for="mesCompraImovel"><b>Mês da Compra do Imóvel</b></label>
                <input type="number" id="mesCompraImovel" value="0" class="valor">
            </div>
        </div>
        
        <div class="scenario-selection">
            <button id="btnComprarImovel" class="scenario-btn selected">Comprar Imóvel</button>
            <button id="btnDeixarRendendo" class="scenario-btn">Deixar Rendendo</button>
        </div>

        <div class="resultados">
            <h2>Resultados da Simulação</h2>
            <div class="valores-finais">
                <p><b id="patrimonioConsorcioLabel">Patrimônio Consórcio:</b> <span id="patrimonioConsorcio">R$ 0,00</span></p>
                <p><b>Patrimônio Renda Fixa:</b> <span id="patrimonioRendaFixa">R$ 0,00</span></p>
            </div>
            <canvas id="graficoComparativo"></canvas>
            <div class="custo-valorizacao">
                <b>Custo Total (dinheiro que saiu):</b> <span id="custoTotalOutflow">R$ 0,00</span>
                <br>
                <b>Soma Total dos Aportes:</b> <span id="somaAportesTotal">R$ 0,00</span>
                <br>
                <span id="labelValorFinalImovel"><b>Valor Final do Imóvel:</b></span> <span id="valorFinalImovel">R$ 0,00</span>
            </div>
            
            <div class="table-container">
                <h3>Detalhe do Fluxo de Caixa (Mensal)</h3>
                <table id="cashFlowTable">
                    <thead>
                        <tr>
                            <th>Mês</th>
                            <th>Parcela Consórcio</th>
                            <th>Seguro</th>
                            <th>Aluguel</th>
                            <th>Lance Recurso Próprio</th>
                            <th>Lance Total Abatido</th>
                            <th>Fluxo de Caixa Líquido</th>
                            <th>Aporte Renda Fixa</th>
                            <th>Patrimônio Consórcio</th>
                            <th>Patrimônio Renda Fixa</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Variável global para rastrear o cenário selecionado
        let cenarioSelecionado = 'comprarImovel';
        let seguroHabilitado = false;
        let myChart;
        let ctx;
        
        // Função utilitária para converter strings formatadas em números
        function parseValue(inputElement) {
            const value = inputElement.value;
            let cleanedValue = value.replace(/[^0-9,]/g, '').replace(',', '.');
            if (inputElement.dataset.tipo === 'percentual') {
                cleanedValue = cleanedValue.replace('%', '');
            }
            return parseFloat(cleanedValue);
        }

        // Função para formatar valores monetários para a tabela
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }
        
        // Funções para formatar e desformatar valores nos inputs
        function formatInputForDisplay(inputElement) {
            const tipo = inputElement.dataset.tipo;
            const numberValue = parseValue(inputElement);
            if (!isNaN(numberValue)) {
                if (tipo === 'moeda') {
                    inputElement.value = `R$ ${numberValue.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                } else if (tipo === 'percentual') {
                    inputElement.value = `${numberValue.toLocaleString('pt-BR')} %`;
                }
            } else {
                inputElement.value = '';
            }
        }

        function unformatInputForEditing(inputElement) {
            const numberValue = parseValue(inputElement);
            inputElement.value = isNaN(numberValue) ? '' : numberValue.toString().replace('.', ',');
        }


        // Simulação principal
        function simularInvestimento(parametros) {
            let {
                valorCarta,
                taxaAdmTotal,
                fundoReservaTotal,
                percentualSeguroMensal,
                prazoTotalMeses,
                percentualReducao,
                mesContemplacao,
                mesCompraImovel,
                valorLanceRecursoProprio,
                percentualLanceEmbutido,
                reajusteAnualCarta,
                rendimentoAnualRF,
                percentualAluguel,
                valorizacaoAnualImovel,
                seguroHabilitado
            } = parametros;

            // Resetar dados do gráfico a cada simulação
            let labelsGrafico = [];
            let dadosGraficoConsorcio = [];
            let dadosGraficoRendaFixa = [];
            let monthlyData = [];

            // Conversão de percentuais para decimais
            const percentualReducaoDecimal = percentualReducao / 100;
            const reajusteAnualCartaDecimal = reajusteAnualCarta / 100;
            const valorizacaoAnualImovelDecimal = valorizacaoAnualImovel / 100;
            const rendimentoMensalRF = Math.pow(1 + (rendimentoAnualRF / 100), 1 / 12) - 1;
            
            let valorCartaAtualizada = valorCarta;
            
            // A taxa de adm e o fundo de reserva são calculados sobre a carta original
            let saldoDevedor = valorCarta;
            let saldoTaxaAdm = valorCarta * (taxaAdmTotal / 100);
            let saldoFundoReserva = valorCarta * (fundoReservaTotal / 100);
            
            const parcelaBaseOriginal = valorCarta / prazoTotalMeses;
            const parcelaTaxaAdmOriginal = (valorCarta * (taxaAdmTotal / 100)) / prazoTotalMeses;
            const parcelaFundoReservaOriginal = (valorCarta * (fundoReservaTotal / 100)) / prazoTotalMeses;
            const parcelaPreContemplacao = (parcelaBaseOriginal + parcelaTaxaAdmOriginal + parcelaFundoReservaOriginal) * (1 - percentualReducaoDecimal);
            
            let patrimonioConsorcio = 0;
            let patrimonioRendaFixa = 0;
            let custoTotalOutflow = 0;
            let somaAportesTotal = 0;
            let valorImovelBase = 0;
            let valorAluguel = 0;
            
            // Simula mês a mês
            for (let mes = 1; mes <= prazoTotalMeses; mes++) {

                // Reajuste anual da carta e saldos
                if (mes % 12 === 0) {
                    valorCartaAtualizada *= (1 + reajusteAnualCartaDecimal);
                }

                let parcelaConsorcio = 0;
                let valorSeguro = seguroHabilitado ? valorCartaAtualizada * (percentualSeguroMensal / 100) : 0;
                let lanceRecursoProprioNoMes = 0;
                let lanceTotalAbatidoNoMes = 0;
                let fluxoDeCaixaLiquido = 0;
                let aporteParaRendaFixa = 0;

                if (mes < mesContemplacao) {
                    saldoDevedor -= parcelaBaseOriginal;
                    saldoTaxaAdm -= parcelaTaxaAdmOriginal;
                    saldoFundoReserva -= parcelaFundoReservaOriginal;
                    parcelaConsorcio = parcelaPreContemplacao;
                    
                    fluxoDeCaixaLiquido = parcelaConsorcio + valorSeguro;
                    
                    if (cenarioSelecionado === 'deixarRendendo') {
                        patrimonioConsorcio = (patrimonioConsorcio + fluxoDeCaixaLiquido) * (1 + rendimentoMensalRF);
                    } else {
                        patrimonioConsorcio = 0;
                    }
                    aporteParaRendaFixa = fluxoDeCaixaLiquido;

                } else if (mes === mesContemplacao) {
                    parcelaConsorcio = parcelaPreContemplacao;
                    lanceRecursoProprioNoMes = valorLanceRecursoProprio;
                    
                    // Lógica corrigida para calcular o lance embutido com base na carta atualizada
                    const valorLanceEmbutido = valorCartaAtualizada * (percentualLanceEmbutido / 100);
                    const valorLanceTotal = valorLanceRecursoProprio + valorLanceEmbutido;
                    lanceTotalAbatidoNoMes = valorLanceTotal;

                    const saldoDevedorNaContemplacao = saldoDevedor + saldoTaxaAdm + saldoFundoReserva;
                    const novoSaldoPosLance = saldoDevedorNaContemplacao - valorLanceTotal;

                    // Recalcula os saldos remanescentes após o lance
                    const proporcao = novoSaldoPosLance / saldoDevedorNaContemplacao;
                    saldoDevedor *= proporcao;
                    saldoTaxaAdm *= proporcao;
                    saldoFundoReserva *= proporcao;
                    
                    const valorCreditoLiquido = valorCartaAtualizada - valorLanceEmbutido;
                    valorImovelBase = valorCreditoLiquido;
                    
                    if (cenarioSelecionado === 'comprarImovel') {
                        patrimonioConsorcio = valorImovelBase;
                        valorAluguel = valorImovelBase * (percentualAluguel / 100);
                        fluxoDeCaixaLiquido = parcelaConsorcio + valorSeguro + lanceRecursoProprioNoMes - valorAluguel;
                    } else { // Deixar Rendendo
                        patrimonioConsorcio = (patrimonioConsorcio + valorLanceRecursoProprio) * (1 + rendimentoMensalRF);
                        fluxoDeCaixaLiquido = parcelaConsorcio + valorSeguro + lanceRecursoProprioNoMes;
                    }
                    
                    aporteParaRendaFixa = Math.max(0, fluxoDeCaixaLiquido);

                } else if (mes > mesContemplacao) {
                    const parcelasRestantes = prazoTotalMeses - (mes -1);

                    const parcelaCredito = saldoDevedor / parcelasRestantes;
                    const parcelaTaxaAdm = saldoTaxaAdm / parcelasRestantes;
                    const parcelaFundoReserva = saldoFundoReserva / parcelasRestantes;
                    
                    // Abatimento correto dos saldos
                    saldoDevedor -= parcelaCredito;
                    saldoTaxaAdm -= parcelaTaxaAdm;
                    saldoFundoReserva -= parcelaFundoReserva;
                    
                    parcelaConsorcio = parcelaCredito + parcelaTaxaAdm + parcelaFundoReserva;
                    
                    if (cenarioSelecionado === 'comprarImovel') {
                        // Atualiza o valor do imóvel anualmente
                        if ((mes - mesContemplacao) % 12 === 0) {
                            valorImovelBase *= (1 + valorizacaoAnualImovelDecimal);
                            valorAluguel = valorImovelBase * (percentualAluguel / 100);
                        }
                        patrimonioConsorcio = valorImovelBase;
                        fluxoDeCaixaLiquido = (parcelaConsorcio + valorSeguro) - valorAluguel;
                    } else { // Deixar Rendendo
                        fluxoDeCaixaLiquido = parcelaConsorcio + valorSeguro;
                        
                        if (mesCompraImovel > 0 && mes >= mesCompraImovel) {
                            if (mes === mesCompraImovel) {
                                valorImovelBase = (valorCartaAtualizada - valorLanceEmbutido) + valorLanceRecursoProprio;
                                patrimonioConsorcio = valorImovelBase; 
                                valorAluguel = valorImovelBase * (percentualAluguel / 100);
                            } else {
                                if ((mes - mesCompraImovel) % 12 === 0) {
                                     valorImovelBase *= (1 + valorizacaoAnualImovelDecimal);
                                     valorAluguel = valorImovelBase * (percentualAluguel / 100);
                                }
                            }
                            fluxoDeCaixaLiquido = (parcelaConsorcio + valorSeguro) - valorAluguel;
                            patrimonioConsorcio = valorImovelBase;
                        } else {
                            patrimonioConsorcio = (patrimonioConsorcio + fluxoDeCaixaLiquido) * (1 + rendimentoMensalRF);
                        }
                    }
                    aporteParaRendaFixa = Math.max(0, fluxoDeCaixaLiquido);
                }
                
                // Lógica de cálculo do patrimônio da renda fixa
                patrimonioRendaFixa = (patrimonioRendaFixa + aporteParaRendaFixa) * (1 + rendimentoMensalRF);
                custoTotalOutflow += Math.max(0, fluxoDeCaixaLiquido);
                somaAportesTotal += aporteParaRendaFixa;
                
                if (mes % 12 === 0 || mes === prazoTotalMeses) {
                    labelsGrafico.push(`Ano ${Math.ceil(mes / 12)}`);
                    dadosGraficoConsorcio.push(patrimonioConsorcio);
                    dadosGraficoRendaFixa.push(patrimonioRendaFixa);
                }
                
                monthlyData.push({
                    mes: mes,
                    parcelaConsorcio: parcelaConsorcio,
                    valorSeguro: valorSeguro,
                    valorAluguel: valorAluguel,
                    lanceRecursoProprio: lanceRecursoProprioNoMes,
                    lanceTotalAbatido: lanceTotalAbatidoNoMes,
                    fluxoCaixa: fluxoDeCaixaLiquido,
                    aporteMensalRF: aporteParaRendaFixa,
                    patrimonioConsorcio: patrimonioConsorcio,
                    patrimonioRendaFixa: patrimonioRendaFixa
                });
            }
            
            return {
                patrimonioFinalConsorcio: patrimonioConsorcio,
                patrimonioFinalRendaFixa: patrimonioRendaFixa,
                dadosGraficoConsorcio,
                dadosGraficoRendaFixa,
                labelsGrafico,
                custoTotalOutflow,
                somaAportesTotal,
                valorFinalImovel: valorImovelBase,
                valorAluguelNaContemplacao: valorAluguel,
                monthlyData
            };
        }

        // Função para popular a tabela com os dados da simulação
        function displayCashFlowTable(data) {
            const tableBody = document.querySelector('#cashFlowTable tbody');
            tableBody.innerHTML = ''; // Limpa a tabela antes de preencher

            data.forEach(mesData => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${mesData.mes}</td>
                    <td>${formatCurrency(mesData.parcelaConsorcio)}</td>
                    <td>${mesData.valorSeguro ? formatCurrency(mesData.valorSeguro) : '-'}</td>
                    <td>${mesData.valorAluguel ? formatCurrency(mesData.valorAluguel) : '-'}</td>
                    <td>${mesData.lanceRecursoProprio ? formatCurrency(mesData.lanceRecursoProprio) : '-'}</td>
                    <td>${mesData.lanceTotalAbatido ? formatCurrency(mesData.lanceTotalAbatido) : '-'}</td>
                    <td>${formatCurrency(mesData.fluxoCaixa)}</td>
                    <td>${formatCurrency(mesData.aporteMensalRF)}</td>
                    <td>${formatCurrency(mesData.patrimonioConsorcio)}</td>
                    <td>${formatCurrency(mesData.patrimonioRendaFixa)}</td>
                `;
                tableBody.appendChild(row);
            });
        }
        
        function atualizarSimulacao() {
            const parametros = {
                valorCarta: parseValue(document.getElementById('valorCarta')),
                taxaAdmTotal: parseValue(document.getElementById('taxaAdmTotal')),
                fundoReservaTotal: parseValue(document.getElementById('fundoReservaTotal')),
                percentualSeguroMensal: parseValue(document.getElementById('percentualSeguroMensal')),
                prazoTotalMeses: parseInt(document.getElementById('prazoTotalMeses').value),
                percentualReducao: parseValue(document.getElementById('percentualReducao')),
                mesContemplacao: parseInt(document.getElementById('mesContemplacao').value),
                mesCompraImovel: parseInt(document.getElementById('mesCompraImovel').value),
                valorLanceRecursoProprio: parseValue(document.getElementById('valorLanceRecursoProprio')),
                percentualLanceEmbutido: parseValue(document.getElementById('percentualLanceEmbutido')),
                reajusteAnualCarta: parseValue(document.getElementById('reajusteAnualCarta')),
                rendimentoAnualRF: parseValue(document.getElementById('rendimentoAnualRF')),
                percentualAluguel: parseValue(document.getElementById('percentualAluguel')),
                valorizacaoAnualImovel: parseValue(document.getElementById('valorizacaoAnualImovel')),
                seguroHabilitado: seguroHabilitado
            };

            const errorMessageElement = document.getElementById('error-message');
            // Validação das novas regras
            if (parametros.percentualLanceEmbutido > 50) {
                errorMessageElement.innerText = "O lance embutido não pode ultrapassar 50% do valor da carta de crédito.";
                errorMessageElement.style.display = 'block';
                return;
            }
            if (cenarioSelecionado === 'deixarRendendo' && parametros.mesCompraImovel > 0) {
                if (parametros.mesCompraImovel < parametros.mesContemplacao) {
                    errorMessageElement.innerText = "O mês da compra do imóvel não pode ser menor que o mês da contemplação.";
                    errorMessageElement.style.display = 'block';
                    return;
                }
                if (parametros.mesCompraImovel > parametros.prazoTotalMeses) {
                    errorMessageElement.innerText = "O mês da compra do imóvel não pode ser maior que o prazo total do consórcio.";
                    errorMessageElement.style.display = 'block';
                    return;
                }
            }
            errorMessageElement.style.display = 'none';
            
            // Lógica corrigida para calcular o valor do lance com recursos próprios e embutido
            let valorCartaContemplacao = parametros.valorCarta;
            for (let i = 1; i < parametros.mesContemplacao; i++) {
                if (i % 12 === 0) {
                    valorCartaContemplacao *= (1 + parametros.reajusteAnualCarta / 100);
                }
            }
            const valorLanceEmbutido = valorCartaContemplacao * (parametros.percentualLanceEmbutido / 100);
            const valorLanceTotal = parametros.valorLanceRecursoProprio + valorLanceEmbutido;
            const valorCreditoPosContemplacao = valorCartaContemplacao - valorLanceEmbutido;
            
            document.getElementById('valorLance').innerText = `${new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorLanceTotal)} (${(valorLanceTotal / valorCartaContemplacao * 100).toFixed(2)}%)`;
            document.getElementById('valorCreditoPosContemplacao').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorCreditoPosContemplacao);
            
            // Condicional para mudar a label do patrimônio
            if (cenarioSelecionado === 'deixarRendendo') {
                document.getElementById('patrimonioConsorcioLabel').innerText = 'Patrimônio Investido:';
                document.getElementById('labelValorFinalImovel').style.display = 'none';
                document.getElementById('valorFinalImovel').style.display = 'none';
            } else {
                document.getElementById('patrimonioConsorcioLabel').innerText = 'Patrimônio Consórcio:';
                document.getElementById('labelValorFinalImovel').style.display = 'inline';
                document.getElementById('valorFinalImovel').style.display = 'inline';
            }

            const resultado = simularInvestimento(parametros);
            
            document.getElementById('aluguelInicialDisplay').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(resultado.valorAluguelNaContemplacao);
            document.getElementById('patrimonioConsorcio').innerText = `R$ ${resultado.patrimonioFinalConsorcio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('patrimonioRendaFixa').innerText = `R$ ${resultado.patrimonioFinalRendaFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('custoTotalOutflow').innerText = `R$ ${resultado.custoTotalOutflow.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('somaAportesTotal').innerText = `R$ ${resultado.somaAportesTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('valorFinalImovel').innerText = `R$ ${resultado.valorFinalImovel.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: resultado.labelsGrafico,
                    datasets: [{
                        label: 'Patrimônio Consórcio',
                        data: resultado.dadosGraficoConsorcio,
                        borderColor: '#FF6400',
                        backgroundColor: 'rgba(255, 100, 0, 0.2)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Patrimônio Renda Fixa',
                        data: resultado.dadosGraficoRendaFixa,
                        borderColor: '#464646',
                        backgroundColor: 'rgba(70, 70, 70, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `R$ ${context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
            
            // Atualiza a tabela de fluxo de caixa
            displayCashFlowTable(resultado.monthlyData);
        }

        // Event listeners para os botões de seleção de seguro
        const btnComSeguro = document.getElementById('btnComSeguro');
        const btnSemSeguro = document.getElementById('btnSemSeguro');
        btnComSeguro.addEventListener('click', () => {
            seguroHabilitado = true;
            btnComSeguro.classList.add('selected');
            btnSemSeguro.classList.remove('selected');
            atualizarSimulacao();
        });
        btnSemSeguro.addEventListener('click', () => {
            seguroHabilitado = false;
            btnSemSeguro.classList.add('selected');
            btnComSeguro.classList.remove('selected');
            atualizarSimulacao();
        });

        // Event listeners para os botões de seleção de cenário
        const mesCompraImovelGroup = document.getElementById('mesCompraImovelGroup');
        const btnComprarImovel = document.getElementById('btnComprarImovel');
        const btnDeixarRendendo = document.getElementById('btnDeixarRendendo');

        btnComprarImovel.addEventListener('click', () => {
            cenarioSelecionado = 'comprarImovel';
            btnComprarImovel.classList.add('selected');
            btnDeixarRendendo.classList.remove('selected');
            mesCompraImovelGroup.classList.add('hidden-input-group');
            document.getElementById('mesCompraImovel').value = 0;
            atualizarSimulacao();
        });

        btnDeixarRendendo.addEventListener('click', () => {
            cenarioSelecionado = 'deixarRendendo';
            btnDeixarRendendo.classList.add('selected');
            btnComprarImovel.classList.remove('selected');
            mesCompraImovelGroup.classList.remove('hidden-input-group');
            atualizarSimulacao();
        });
        
        // Event listeners para os campos de input
        const inputs = document.querySelectorAll('.inputs input.valor');
        inputs.forEach(input => {
            const tipo = input.dataset.tipo;
            if (tipo === 'moeda' || tipo === 'percentual') {
                // Ao focar, remove a formatação para facilitar a digitação
                input.addEventListener('focus', () => {
                    unformatInputForEditing(input);
                });
                // Ao perder o foco, formata o valor e atualiza a simulação
                input.addEventListener('blur', () => {
                    formatInputForDisplay(input);
                    atualizarSimulacao();
                });
            } else {
                // Para inputs não-formatados, apenas atualiza no 'blur'
                input.addEventListener('blur', atualizarSimulacao);
            }
        });
        
        // Formatação de valores ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            inputs.forEach(input => {
                formatInputForDisplay(input);
            });
            ctx = document.getElementById('graficoComparativo').getContext('2d');
            atualizarSimulacao();
        });
    </script>
</body>
</html>
