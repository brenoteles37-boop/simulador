<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulador de Patrimônio</title>
    <!-- Inclui o Chart.js para o gráfico -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Links para a fonte Outfit do Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos gerais e reset */
        body { font-family: 'Outfit', sans-serif; font-weight: 300; margin: 0; padding: 20px 10px; background: #f6f8fb; color: #464646; }
        .container { max-width: 800px; margin: 28px auto; padding: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(11,36,71,0.06); }

        /* Títulos e textos de destaque */
        h1 { font-size: 24px; margin-bottom: 10px; color: #464646; text-align: center; }
        b { font-family: 'Outfit', sans-serif; font-weight: 700; color: #FF6400; }
        p.lead { color: #374151; margin-top: 0; text-align: center; }
        
        /* Layout dos inputs, otimizado para mobile e desktop */
        .inputs { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 14px; color: #334155; margin-bottom: 5px; }
        input.valor { padding: 10px; border: 1px solid #e6e9ef; border-radius: 8px; font-size: 16px; }

        /* Estilos específicos para seleção de seguro e cenários */
        .seguro-container { display: flex; flex-direction: column; gap: 10px; }
        .radio-group { display: flex; align-items: center; justify-content: space-around; gap: 10px; }
        .scenario-selection { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        
        /* Botões de rádio/cenário */
        .radio-btn, .scenario-btn { 
            padding: 12px 16px; 
            font-size: 14px; 
            font-weight: bold; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 1px solid #464646; 
            background-color: white; 
            color: #464646; 
            text-align: center; 
            transition: all 0.2s ease-in-out; 
            flex: 1; /* Permite que os botões se expandam */
        }
        .radio-btn.selected, .scenario-btn.selected { background-color: #464646; color: white; }

        /* Seção de resultados e valores finais */
        .resultados { margin-top: 20px; text-align: center; }
        .valores-finais { 
            display: flex; 
            flex-direction: column; /* Empilha no mobile por padrão */
            align-items: center; 
            gap: 10px; 
            margin-bottom: 20px; 
        }
        .valores-finais p { font-size: 18px; font-weight: bold; color: #464646; }
        
        /* Gráfico e display de valores */
        canvas { max-width: 100%; height: auto; margin-bottom: 20px; }
        .value-display { 
            padding: 10px; 
            border: 1px solid #e6e9ef; 
            border-radius: 8px; 
            font-size: 16px; 
            background-color: #f0f2f5; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        /* Melhorias para dispositivos móveis (telas pequenas) */
        @media (max-width: 600px) {
            .container { padding: 15px; }
            .inputs { grid-template-columns: 1fr; } /* Inputs em uma única coluna */
            .radio-group, .scenario-selection { 
                flex-direction: column; /* Botões de seleção empilham */
            }
            .radio-btn, .scenario-btn { width: 100%; } /* Botões ocupam a largura total */
            .valores-finais { flex-direction: column; } /* Valores finais empilham */
        }

        /* Estilo para a barra de rolagem para um visual mais limpo */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background-color: #FF6400; border-radius: 4px; }
        ::-webkit-scrollbar-track { background-color: #d1d5db; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulador de Patrimônio</h1>
        <p class="lead">Compare o crescimento do seu patrimônio com <b>consórcio</b> para compra de imóvel vs. investimento em <b>renda fixa</b>.</p>

        <div class="inputs">
            <!-- Valor da Carta de Crédito -->
            <div class="input-group">
                <label for="valorCarta"><b>Valor da Carta de Crédito (R$)</b></label>
                <input type="text" id="valorCarta" value="R$ 100.000,00" class="valor" data-tipo="moeda">
            </div>
            <!-- Taxa de Administração Total -->
            <div class="input-group">
                <label for="taxaAdmTotal"><b>Taxa de Administração Total (%)</b></label>
                <input type="text" id="taxaAdmTotal" value="18%" class="valor" data-tipo="percentual">
            </div>
            <!-- Fundo de Reserva Total -->
            <div class="input-group">
                <label for="fundoReservaTotal"><b>Fundo de Reserva Total (%)</b></label>
                <input type="text" id="fundoReservaTotal" value="2%" class="valor" data-tipo="percentual">
            </div>
            <!-- Seguro Mensal -->
            <div class="seguro-container">
                <div class="input-group">
                    <label for="percentualSeguroMensal"><b>Seguro Mensal (% da Carta)</b></label>
                    <input type="text" id="percentualSeguroMensal" value="0,038%" class="valor" data-tipo="percentual">
                </div>
                <div class="radio-group">
                    <button id="btnComSeguro" class="radio-btn selected"><b>Com Seguro</b></button>
                    <button id="btnSemSeguro" class="radio-btn"><b>Sem Seguro</b></button>
                </div>
            </div>
            <!-- Prazo Total -->
            <div class="input-group">
                <label for="prazoTotalMeses"><b>Prazo Total (meses)</b></label>
                <input type="number" id="prazoTotalMeses" value="80" class="valor">
            </div>
            <!-- Redução da Parcela -->
            <div class="input-group">
                <label for="percentualReducao"><b>Redução da Parcela até Contemplação (%)</b></label>
                <input type="text" id="percentualReducao" value="50%" class="valor" data-tipo="percentual">
            </div>
            <!-- Mês da Contemplação -->
            <div class="input-group">
                <label for="mesContemplacao"><b>Mês da Contemplação</b></label>
                <input type="number" id="mesContemplacao" value="12" class="valor">
            </div>
            <!-- Percentual do Lance -->
            <div class="input-group">
                <label for="percentualLance"><b>Percentual do Lance (%)</b></label>
                <input type="text" id="percentualLance" value="30%" class="valor" data-tipo="percentual">
            </div>
            <!-- Valor do Lance (Calculado) -->
            <div class="input-group">
                <label for="valorLance"><b>Valor do Lance (R$)</b></label>
                <p id="valorLance" class="value-display">R$ 0,00</p>
            </div>
            <!-- Reajuste Anual da Carta -->
            <div class="input-group">
                <label for="reajusteAnualCarta"><b>Reajuste Anual da Carta (%)</b></label>
                <input type="text" id="reajusteAnualCarta" value="5%" class="valor" data-tipo="percentual">
            </div>
            <!-- Rendimento Anual da Renda Fixa -->
            <div class="input-group">
                <label for="rendimentoAnualRF"><b>Rendimento Anual da Renda Fixa (%)</b></label>
                <input type="text" id="rendimentoAnualRF" value="12%" class="valor" data-tipo="percentual">
            </div>
            <!-- Percentual do Aluguel -->
            <div class="input-group">
                <label for="percentualAluguel"><b>Percentual do Aluguel (%)</b></label>
                <input type="text" id="percentualAluguel" value="0,5%" class="valor" data-tipo="percentual">
            </div>
            <!-- Valor do Aluguel Inicial (Calculado) -->
            <div class="input-group">
                <label for="aluguelInicialDisplay"><b>Aluguel Inicial (R$)</b></label>
                <p id="aluguelInicialDisplay" class="value-display">R$ 0,00</p>
            </div>
            <!-- Valorização Anual do Imóvel -->
            <div class="input-group">
                <label for="valorizacaoAnualImovel"><b>Valorização Anual do Imóvel (%)</b></label>
                <input type="text" id="valorizacaoAnualImovel" value="5%" class="valor" data-tipo="percentual">
            </div>
        </div>
        
        <!-- Botões de seleção de cenário -->
        <div class="scenario-selection">
            <button id="btnComprarImovel" class="scenario-btn selected">Comprar Imóvel</button>
            <button id="btnDeixarRendendo" class="scenario-btn">Deixar Rendendo</button>
        </div>

        <div class="resultados">
            <h2>Resultados da Simulação</h2>
            <div class="valores-finais">
                <p><b id="patrimonioConsorcioLabel">Patrimônio Consórcio:</b> <span id="patrimonioConsorcio">R$ 0,00</span></p>
                <p><b>Patrimônio Renda Fixa:</b> <span id="patrimonioRendaFixa">R$ 0,00</span></p>
            </div>
            <canvas id="graficoComparativo"></canvas>
            <div class="custo-valorizacao">
                <b>Custo Total Estimado (Parcelas + Aluguel):</b> <span id="custoTotalOutflow">R$ 0,00</span>
                <br>
                <b>Soma Total dos Aportes:</b> <span id="somaAportesTotal">R$ 0,00</span>
                <br>
                <span id="labelValorFinalImovel"><b>Valor Final do Imóvel:</b></span> <span id="valorFinalImovel">R$ 0,00</span>
            </div>
        </div>
    </div>

    <script>
        // Variável global para rastrear o cenário selecionado
        let cenarioSelecionado = 'comprarImovel';
        let seguroHabilitado = true;
        let myChart;
        let ctx;
        
        // Função utilitária para converter strings formatadas em números
        function parseValue(inputElement) {
            const value = inputElement.value;
            let cleanedValue = value.replace(/[^0-9,]/g, '').replace(',', '.');
            if (inputElement.dataset.tipo === 'percentual') {
                cleanedValue = cleanedValue.replace('%', '');
            }
            return parseFloat(cleanedValue);
        }

        // Função utilitária para formatar números para exibição
        function formatValue(inputElement, value) {
            if (inputElement.dataset.tipo === 'moeda') {
                return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
            }
            if (inputElement.dataset.tipo === 'percentual') {
                return value.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '%';
            }
            return value;
        }

        // Simulação principal
        function simularInvestimento(parametros) {
            let {
                valorCarta,
                taxaAdmTotal,
                fundoReservaTotal,
                percentualSeguroMensal,
                prazoTotalMeses,
                percentualReducao,
                mesContemplacao,
                percentualLance,
                reajusteAnualCarta,
                rendimentoAnualRF,
                percentualAluguel,
                valorizacaoAnualImovel,
                seguroHabilitado
            } = parametros;

            // Resetar dados do gráfico a cada simulação
            let labelsGrafico = [];
            let dadosGraficoConsorcio = [];
            let dadosGraficoRendaFixa = [];

            // Conversão de percentuais para decimais
            const percentualReducaoDecimal = percentualReducao / 100;
            const reajusteAnualCartaDecimal = reajusteAnualCarta / 100;
            const rendimentoMensalRF = Math.pow(1 + rendimentoAnualRF / 100, 1 / 12) - 1;

            let valorCartaAtualizada = valorCarta;
            let saldoDevedor = valorCarta;
            let saldoTaxaAdm = valorCarta * (taxaAdmTotal / 100);
            let saldoFundoReserva = valorCarta * (fundoReservaTotal / 100);

            let patrimonioConsorcio = 0;
            let patrimonioRendaFixa = 0;
            let custoTotalOutflow = 0;
            let somaAportesTotal = 0;
            let valorImovel = 0;
            
            // Calculate the total value of the consorcio (letter of credit + fees)
            const valorTotalConsorcio = valorCarta + (valorCarta * (taxaAdmTotal/100)) + (valorCarta * (fundoReservaTotal/100));

            // Calculate the lance based on the total value
            const valorLance = valorTotalConsorcio * (percentualLance / 100);

            // Simula mês a mês
            for (let mes = 1; mes <= prazoTotalMeses; mes++) {

                // Reajuste anual da carta, saldos e imóvel
                if ((mes - 1) % 12 === 0 && mes > 1) {
                    valorCartaAtualizada *= (1 + reajusteAnualCartaDecimal);
                    saldoDevedor *= (1 + reajusteAnualCartaDecimal);
                    saldoTaxaAdm *= (1 + reajusteAnualCartaDecimal);
                    saldoFundoReserva *= (1 + reajusteAnualCartaDecimal);
                    if (cenarioSelecionado === 'comprarImovel' && mes > mesContemplacao) {
                        valorImovel *= (1 + valorizacaoAnualImovel / 100);
                    }
                }

                let aporteMensal = 0;
                let parcelaConsorcio = 0;

                // Lógica de pagamento antes da contemplação
                if (mes < mesContemplacao) {
                    const parcelaBase = (valorCarta / prazoTotalMeses);
                    const parcelaTaxaAdm = (valorCarta * (taxaAdmTotal/100) / prazoTotalMeses);
                    const parcelaFundoReserva = (valorCarta * (fundoReservaTotal/100) / prazoTotalMeses);
                    
                    parcelaConsorcio = (parcelaBase + parcelaTaxaAdm + parcelaFundoReserva) * (1 - percentualReducaoDecimal);
                    const seguroMensalCalculado = seguroHabilitado ? valorCartaAtualizada * (percentualSeguroMensal / 100) : 0;
                    
                    const valorAluguelMensal = valorCartaAtualizada * (percentualAluguel / 100);

                    aporteMensal = Math.max(0, (parcelaConsorcio + seguroMensalCalculado) - valorAluguelMensal);
                    
                    custoTotalOutflow += parcelaConsorcio + seguroMensalCalculado + valorAluguelMensal;
                    somaAportesTotal += aporteMensal;
                    
                    patrimonioRendaFixa = (patrimonioRendaFixa + aporteMensal) * (1 + rendimentoMensalRF);

                    // O patrimônio do consórcio é zero até a contemplação
                    patrimonioConsorcio = 0;

                } 
                // Lógica no mês da contemplação
                else if (mes === mesContemplacao) {
                    const parcelaBase = (valorCarta / prazoTotalMeses);
                    const parcelaTaxaAdm = (valorCarta * (taxaAdmTotal/100) / prazoTotalMeses);
                    const parcelaFundoReserva = (valorCarta * (fundoReservaTotal/100) / prazoTotalMeses);

                    parcelaConsorcio = (parcelaBase + parcelaTaxaAdm + parcelaFundoReserva) * (1 - percentualReducaoDecimal);
                    const seguroMensalCalculado = seguroHabilitado ? valorCartaAtualizada * (percentualSeguroMensal / 100) : 0;
                    
                    const valorAluguelMensal = valorCartaAtualizada * (percentualAluguel / 100);

                    aporteMensal = (parcelaConsorcio + seguroMensalCalculado) + valorLance - valorAluguelMensal;
                    
                    custoTotalOutflow += parcelaConsorcio + seguroMensalCalculado + valorLance + valorAluguelMensal;
                    somaAportesTotal += aporteMensal;
                    
                    patrimonioRendaFixa = (patrimonioRendaFixa + aporteMensal) * (1 + rendimentoMensalRF);

                    valorImovel = valorCartaAtualizada;
                    patrimonioConsorcio = valorImovel;
                    
                    // Amortiza a dívida com o lance
                    saldoDevedor -= valorLance;
                } 
                // Lógica de pagamento após a contemplação
                else if (mes > mesContemplacao) {
                    const parcelasRestantes = prazoTotalMeses - mes + 1;
                    const parcelaCredito = saldoDevedor / parcelasRestantes;
                    const parcelaTaxaAdm = saldoTaxaAdm / parcelasRestantes;
                    const parcelaFundoReserva = saldoFundoReserva / parcelasRestantes;
                    
                    parcelaConsorcio = parcelaCredito + parcelaTaxaAdm + parcelaFundoReserva;
                    const seguroMensalCalculado = seguroHabilitado ? valorCartaAtualizada * (percentualSeguroMensal / 100) : 0;
                    aporteMensal = parcelaConsorcio + seguroMensalCalculado;

                    saldoDevedor -= parcelaCredito;
                    saldoTaxaAdm -= parcelaTaxaAdm;
                    saldoFundoReserva -= parcelaFundoReserva;

                    patrimonioRendaFixa = (patrimonioRendaFixa + aporteMensal) * (1 + rendimentoMensalRF);
                    valorImovel *= (1 + valorizacaoAnualImovel / 100 / 12);
                    patrimonioConsorcio = valorImovel;
                    
                    custoTotalOutflow += aporteMensal;
                    somaAportesTotal += aporteMensal;
                }
                
                // Gravação dos dados anuais para o gráfico
                if (mes % 12 === 0 || mes === prazoTotalMeses) {
                    labelsGrafico.push(`Ano ${Math.ceil(mes / 12)}`);
                    dadosGraficoConsorcio.push(patrimonioConsorcio);
                    dadosGraficoRendaFixa.push(patrimonioRendaFixa);
                }
            }
            
            const valorAluguelInicial = valorCarta * (percentualAluguel / 100);

            return {
                patrimonioFinalConsorcio: patrimonioConsorcio,
                patrimonioFinalRendaFixa: patrimonioRendaFixa,
                dadosGraficoConsorcio,
                dadosGraficoRendaFixa,
                labelsGrafico,
                custoTotalOutflow,
                somaAportesTotal,
                valorFinalImovel: valorImovel,
                valorAluguelNaContemplacao: valorAluguelInicial
            };
        }

        function atualizarSimulacao() {
            const parametros = {
                valorCarta: parseValue(document.getElementById('valorCarta')),
                taxaAdmTotal: parseValue(document.getElementById('taxaAdmTotal')),
                fundoReservaTotal: parseValue(document.getElementById('fundoReservaTotal')),
                percentualSeguroMensal: parseValue(document.getElementById('percentualSeguroMensal')),
                prazoTotalMeses: parseInt(document.getElementById('prazoTotalMeses').value),
                percentualReducao: parseValue(document.getElementById('percentualReducao')),
                mesContemplacao: parseInt(document.getElementById('mesContemplacao').value),
                percentualLance: parseValue(document.getElementById('percentualLance')),
                reajusteAnualCarta: parseValue(document.getElementById('reajusteAnualCarta')),
                rendimentoAnualRF: parseValue(document.getElementById('rendimentoAnualRF')),
                percentualAluguel: parseValue(document.getElementById('percentualAluguel')),
                valorizacaoAnualImovel: parseValue(document.getElementById('valorizacaoAnualImovel')),
                seguroHabilitado: seguroHabilitado
            };
            
            // Calcula o valor total do consórcio (carta + taxas)
            const valorTotalConsorcio = parametros.valorCarta + (parametros.valorCarta * (parametros.taxaAdmTotal/100)) + (parametros.valorCarta * (parametros.fundoReservaTotal/100));

            // Recalcula o valor do lance com base no valor total do consórcio
            const valorLance = valorTotalConsorcio * (parametros.percentualLance / 100);
            document.getElementById('valorLance').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(valorLance);

            const resultado = simularInvestimento(parametros);

            document.getElementById('aluguelInicialDisplay').innerText = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(resultado.valorAluguelNaContemplacao);
            document.getElementById('patrimonioConsorcio').innerText = `R$ ${resultado.patrimonioFinalConsorcio.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('patrimonioRendaFixa').innerText = `R$ ${resultado.patrimonioFinalRendaFixa.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('custoTotalOutflow').innerText = `R$ ${resultado.custoTotalOutflow.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('somaAportesTotal').innerText = `R$ ${resultado.somaAportesTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            document.getElementById('valorFinalImovel').innerText = `R$ ${resultado.valorFinalImovel.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: resultado.labelsGrafico,
                    datasets: [{
                        label: 'Patrimônio Consórcio',
                        data: resultado.dadosGraficoConsorcio,
                        borderColor: '#FF6400',
                        backgroundColor: 'rgba(255, 100, 0, 0.2)',
                        fill: true,
                        tension: 0.3
                    }, {
                        label: 'Patrimônio Renda Fixa',
                        data: resultado.dadosGraficoRendaFixa,
                        borderColor: '#464646',
                        backgroundColor: 'rgba(70, 70, 70, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'R$ ' + value.toLocaleString('pt-BR');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += `R$ ${context.parsed.y.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Event listeners para os botões de seleção de seguro
        const btnComSeguro = document.getElementById('btnComSeguro');
        const btnSemSeguro = document.getElementById('btnSemSeguro');
        btnComSeguro.addEventListener('click', () => {
            seguroHabilitado = true;
            btnComSeguro.classList.add('selected');
            btnSemSeguro.classList.remove('selected');
            atualizarSimulacao();
        });
        btnSemSeguro.addEventListener('click', () => {
            seguroHabilitado = false;
            btnSemSeguro.classList.add('selected');
            btnComSeguro.classList.remove('selected');
            atualizarSimulacao();
        });

        // Event listeners para os botões de seleção de cenário
        const btnComprarImovel = document.getElementById('btnComprarImovel');
        const btnDeixarRendendo = document.getElementById('btnDeixarRendendo');
        btnComprarImovel.addEventListener('click', () => {
            cenarioSelecionado = 'comprarImovel';
            btnComprarImovel.classList.add('selected');
            btnDeixarRendendo.classList.remove('selected');
            document.getElementById('valorizacaoAnualImovel').disabled = false;
            document.getElementById('percentualAluguel').disabled = false;
            atualizarSimulacao();
        });
        btnDeixarRendendo.addEventListener('click', () => {
            cenarioSelecionado = 'deixarRendendo';
            btnDeixarRendendo.classList.add('selected');
            btnComprarImovel.classList.remove('selected');
            document.getElementById('valorizacaoAnualImovel').disabled = true;
            document.getElementById('percentualAluguel').disabled = true;
            atualizarSimulacao();
        });

        // Event listener para formatar o valor quando o campo perde o foco
        document.querySelectorAll('input.valor[data-tipo]').forEach(input => {
            input.addEventListener('blur', (event) => {
                const parsedValue = parseValue(event.target);
                event.target.value = formatValue(event.target, parsedValue);
            });
            input.addEventListener('focus', (event) => {
                const parsedValue = parseValue(event.target);
                event.target.value = parsedValue;
            });
        });

        // Event listener para atualizar a simulação em tempo real para campos chave
        document.querySelectorAll('input.valor').forEach(input => {
            input.addEventListener('input', atualizarSimulacao);
        });

        document.addEventListener('DOMContentLoaded', () => {
          ctx = document.getElementById('graficoComparativo').getContext('2d');
          atualizarSimulacao();
        });
    </script>
</body>
</html>
